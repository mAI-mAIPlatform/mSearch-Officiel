name: Mises à niveau des dépendances

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate package-lock if missing
        run: npm install --package-lock-only --ignore-scripts

      - name: Generate outdated.json
        run: |
          npm outdated --json > outdated.json || echo "{}" > outdated.json

      - name: Create structured issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const outdated = JSON.parse(
              fs.readFileSync("outdated.json", "utf8")
            );

            if (!outdated || Object.keys(outdated).length === 0) {
              console.log("No outdated dependencies");
              return;
            }

            const { owner, repo } = context.repo;

            const existingIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: "Ajouts"
            });

            for (const [name, info] of Object.entries(outdated)) {

              const title = `Nécessité de mise à niveau d'une dépendance : ${name}`;

              const alreadyExists = existingIssues.data.some(
                issue => issue.title === title
              );

              if (alreadyExists) {
                console.log(`Issue already exists for ${name}`);
                continue;
              }

              const current = info.current || "Inconnue";
              const stable = info.wanted || "Inconnue";
              const experimental = info.latest || "Inconnue";

              const body =
                "## Nom de la dépendance à mettre à niveau\n" +
                name + "\n\n" +
                "## Version actuelle\n" +
                current + "\n\n" +
                "## Nouvelle version (stable)\n" +
                stable + "\n\n" +
                "## Nouvelle version (expérimentale)\n" +
                experimental;

              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                assignees: ["mAI-mAIPlatform"],
                labels: ["Ajouts"]
              });

              console.log(`Created issue for ${name}`);
            }
